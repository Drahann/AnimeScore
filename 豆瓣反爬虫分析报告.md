# ðŸ›¡ï¸ è±†ç“£åçˆ¬è™«æœºåˆ¶åˆ†æžæŠ¥å‘Š

## ðŸ“Š å®žé™…æµ‹è¯•ç»“æžœ

### æµ‹è¯•æ—¶é—´
2025-08-03 20:02:49

### å‘çŽ°çš„åçˆ¬è™«æœºåˆ¶

#### 1. å®‰å…¨éªŒè¯é‡å®šå‘ âœ… **å·²è¯†åˆ«**
- **çŽ°è±¡**: è®¿é—® `movie.douban.com` è¢«é‡å®šå‘åˆ° `sec.douban.com/b?r=...`
- **ç›®çš„**: è¿›è¡Œå®‰å…¨éªŒè¯ï¼Œå¯èƒ½åŒ…æ‹¬éªŒè¯ç ã€è¡Œä¸ºæ£€æµ‹ç­‰
- **å½±å“**: é˜»æ­¢ç›´æŽ¥è®¿é—®ç”µå½±é¡µé¢

#### 2. BrotliåŽ‹ç¼©ç¼–ç  âœ… **å·²è¯†åˆ«**
- **çŽ°è±¡**: å“åº”ä½¿ç”¨BrotliåŽ‹ç¼©ï¼Œaiohttpæ— æ³•è§£ç 
- **é”™è¯¯**: `Can not decode content-encoding: brotli (br). Please install 'Brotli'`
- **å½±å“**: å³ä½¿ç»•è¿‡éªŒè¯ï¼Œä¹Ÿæ— æ³•æ­£ç¡®è§£æžå“åº”å†…å®¹

#### 3. é¦–é¡µè®¿é—®æ­£å¸¸ âœ… **ç¡®è®¤**
- **çŽ°è±¡**: `www.douban.com` è¿”å›ž200çŠ¶æ€ç 
- **è¯´æ˜Ž**: è±†ç“£ä¸»ç«™è®¿é—®æ­£å¸¸ï¼Œé—®é¢˜å‡ºçŽ°åœ¨å­åŸŸå

## ðŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å®‰è£…Brotliæ”¯æŒ
```bash
pip install brotli
```

### æ–¹æ¡ˆ2: ä¿®æ”¹è¯·æ±‚å¤´ç¦ç”¨Brotli
```python
headers = {
    'Accept-Encoding': 'gzip, deflate',  # ç§»é™¤br
    # ... å…¶ä»–å¤´éƒ¨
}
```

### æ–¹æ¡ˆ3: å¤„ç†å®‰å…¨éªŒè¯é¡µé¢
```python
if 'sec.douban.com' in response.url:
    # æ£€æµ‹åˆ°å®‰å…¨éªŒè¯é¡µé¢
    # 1. è§£æžéªŒè¯å‚æ•°
    # 2. æ¨¡æ‹ŸéªŒè¯è¿‡ç¨‹
    # 3. èŽ·å–éªŒè¯åŽçš„cookies
```

### æ–¹æ¡ˆ4: ä½¿ç”¨ç§»åŠ¨ç«¯æŽ¥å£
```python
# ç§»åŠ¨ç«¯é€šå¸¸æ²¡æœ‰å¤æ‚çš„åçˆ¬è™«
mobile_url = "https://m.douban.com/movie/subject/{id}/"
```

## ðŸš€ ç«‹å³å¯è¡Œçš„è§£å†³æ–¹æ¡ˆ

### 1. å®‰è£…Brotliä¾èµ–
```bash
pip install brotli
```

### 2. æ›´æ–°è¯·æ±‚å¤´ç­–ç•¥
```python
def _get_random_headers(self, referer=None):
    headers = {
        'User-Agent': random.choice(self.user_agents),
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
        'Accept-Encoding': 'gzip, deflate',  # ç¦ç”¨brotli
        'Cache-Control': 'max-age=0',
        'Connection': 'keep-alive',
        'Upgrade-Insecure-Requests': '1',
    }
    return headers
```

### 3. å¤„ç†é‡å®šå‘å’ŒéªŒè¯
```python
async def _handle_security_redirect(self, session, response):
    if 'sec.douban.com' in str(response.url):
        logger.warning("æ£€æµ‹åˆ°è±†ç“£å®‰å…¨éªŒè¯é¡µé¢")
        
        # å°è¯•è§£æžéªŒè¯é¡µé¢
        html = await response.text()
        
        # æŸ¥æ‰¾è‡ªåŠ¨è·³è½¬è„šæœ¬æˆ–è¡¨å•
        # æ¨¡æ‹ŸéªŒè¯è¿‡ç¨‹
        
        return await self._complete_verification(session, html)
    
    return response
```

## ðŸ“ˆ æµ‹è¯•ç»“æžœåˆ†æž

### æˆåŠŸçš„éƒ¨åˆ†
- âœ… è±†ç“£ä¸»ç«™ (`www.douban.com`) è®¿é—®æ­£å¸¸
- âœ… åŸºç¡€cookiesèŽ·å–æˆåŠŸ
- âœ… ç½‘ç»œè¿žæŽ¥æ­£å¸¸

### å¤±è´¥çš„éƒ¨åˆ†
- âŒ ç”µå½±å­ç«™è¢«é‡å®šå‘åˆ°å®‰å…¨éªŒè¯
- âŒ Brotliç¼–ç è§£æžå¤±è´¥
- âŒ æ— æ³•å»ºç«‹å®Œæ•´çš„æµè§ˆä¼šè¯

### æˆåŠŸçŽ‡è¯„ä¼°
- **å½“å‰æˆåŠŸçŽ‡**: ~30% (ä»…ä¸»ç«™è®¿é—®)
- **é¢„æœŸæ”¹è¿›åŽ**: ~70% (è§£å†³ç¼–ç +éªŒè¯)
- **æœ€ç»ˆç›®æ ‡**: ~90% (å®Œæ•´ååçˆ¬è™«)

## ðŸŽ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³æ‰§è¡Œ (ä»Šå¤©)
1. **å®‰è£…Brotli**: `pip install brotli`
2. **ä¿®æ”¹è¯·æ±‚å¤´**: ç¦ç”¨brotliç¼–ç 
3. **æµ‹è¯•æ”¹è¿›æ•ˆæžœ**

### çŸ­æœŸä¼˜åŒ– (æœ¬å‘¨)
1. **å®žçŽ°å®‰å…¨éªŒè¯å¤„ç†**
2. **æ·»åŠ ç§»åŠ¨ç«¯å¤‡é€‰æ–¹æ¡ˆ**
3. **å®Œå–„é”™è¯¯é‡è¯•æœºåˆ¶**

### é•¿æœŸç­–ç•¥ (æœ¬æœˆ)
1. **ç ”ç©¶éªŒè¯ç è‡ªåŠ¨è¯†åˆ«**
2. **å»ºç«‹ä»£ç†æ± ç³»ç»Ÿ**
3. **å¼€å‘åˆ†å¸ƒå¼çˆ¬å–**

## ðŸ’¡ æŠ€æœ¯æ´žå¯Ÿ

### è±†ç“£åçˆ¬è™«ç‰¹ç‚¹
1. **åˆ†å±‚é˜²æŠ¤**: ä¸»ç«™â†’å­ç«™â†’å…·ä½“é¡µé¢
2. **åŠ¨æ€éªŒè¯**: æ ¹æ®è¡Œä¸ºæ¨¡å¼è§¦å‘éªŒè¯
3. **æŠ€æœ¯æ‰‹æ®µ**: é‡å®šå‘+ç¼–ç +é¢‘çŽ‡é™åˆ¶

### ç»•è¿‡ç­–ç•¥
1. **æ¸è¿›å¼è®¿é—®**: å…ˆä¸»ç«™â†’å†å­ç«™â†’æœ€åŽå…·ä½“é¡µé¢
2. **ä¼šè¯ä¿æŒ**: ç»´æŠ¤å®Œæ•´çš„æµè§ˆå™¨ä¼šè¯çŠ¶æ€
3. **è¡Œä¸ºæ¨¡æ‹Ÿ**: æ¨¡æ‹ŸçœŸå®žç”¨æˆ·çš„æµè§ˆæ¨¡å¼

## ðŸ” ç›‘æŽ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡
- **è®¿é—®æˆåŠŸçŽ‡**: ç›®æ ‡ >80%
- **æ•°æ®å®Œæ•´æ€§**: ç›®æ ‡ >90%
- **è¯·æ±‚å»¶è¿Ÿ**: ç›®æ ‡ <10ç§’
- **å°ç¦çŽ‡**: ç›®æ ‡ <5%

### ç›‘æŽ§æ–¹æ³•
```python
# æˆåŠŸçŽ‡ç»Ÿè®¡
success_rate = successful_requests / total_requests

# å“åº”æ—¶é—´ç›‘æŽ§
avg_response_time = sum(response_times) / len(response_times)

# é”™è¯¯ç±»åž‹åˆ†æž
error_types = {
    '403': forbidden_count,
    '429': rate_limit_count,
    'timeout': timeout_count,
    'redirect': redirect_count
}
```

---

## ðŸ“ž ç»“è®º

è±†ç“£çš„åçˆ¬è™«æœºåˆ¶æ¯”é¢„æœŸçš„æ›´åŠ å¤æ‚ï¼Œä½†é€šè¿‡ç³»ç»Ÿæ€§çš„åˆ†æžï¼Œæˆ‘ä»¬å·²ç»è¯†åˆ«äº†ä¸»è¦éšœç¢å¹¶åˆ¶å®šäº†å¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚

**å…³é”®å‘çŽ°**:
1. å®‰å…¨éªŒè¯é‡å®šå‘æ˜¯ä¸»è¦éšœç¢
2. Brotliç¼–ç éœ€è¦é¢å¤–æ”¯æŒ
3. åˆ†å±‚è®¿é—®ç­–ç•¥æ˜¯å¿…è¦çš„

**ç«‹å³è¡ŒåŠ¨**:
1. å®‰è£…Brotliæ”¯æŒ
2. ä¿®æ”¹è¯·æ±‚å¤´ç­–ç•¥
3. å®žçŽ°éªŒè¯å¤„ç†é€»è¾‘

é€šè¿‡è¿™äº›æ”¹è¿›ï¼Œé¢„è®¡å¯ä»¥å°†è±†ç“£æ•°æ®èŽ·å–æˆåŠŸçŽ‡æå‡åˆ°70%ä»¥ä¸Šã€‚
